<?php
/*
    modelreview.module for the CoMSES Computational Model Library
    Copyright (C) 2012. Nathan D. Rollins, Research Network for Computational
        Modeling for the SocioEcological Sciences (CoMSES Net)

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

/**
 * Include the module forms
 */
module_load_include('inc', 'modelreview', 'includes/modelreview.pages');

/**
 * Implementation of hook_help()
 */
function modelreview_help($path, $arg) {
  if ($path == 'admin/help#modelreview') {
    $txt = 'The CoMSES Model Review module provides an interface for reviewing and certifying models.';
    return '<p>'. t($txt) .'</p>';
  }
}

/**
 * Implementation of hook_init()
 *
 */
function modelreview_init() {
  drupal_add_css(drupal_get_path('module', 'modelreview') .'/includes/modelreview.css');
}

/**
 * Implementation of hook_theme()
 * 
 */
function modelreview_theme() {
  return array(
    'author_status_page' => array(
      'arguments' => array(
        'review' => array(
          'model_nid' => NULL,
          'modelversion_nid' => NULL,
          'rid' => NULL,
          'sid' => NULL,
          'related' => NULL,
          'statusid' => NULL,
          'statusdate' => NULL,
          'status' => NULL,
          'reviewer' => NULL,
        ),
      ),
      'template' => 'author-status-page',
      'path' => drupal_get_path('module', 'modelreview') .'/tpl',
    ),
    'editor_status_page' => array(
      'arguments' => array(
        'review' => array(
          'model_nid' => NULL,
          'modelversion_nid' => NULL,
          'rid' => NULL,
          'sid' => NULL,
          'related' => NULL,
          'statusid' => NULL,
          'statusdate' => NULL,
          'status' => NULL,
          'reviewer' => NULL,
        ),
      ),
      'template' => 'editor-status-page',
      'path' => drupal_get_path('module', 'modelreview') .'/tpl',
    ),
    'reviewer_status_page' => array(
      'arguments' => array(
        'review' => array(
          'model_nid' => NULL,
          'modelversion_nid' => NULL,
          'rid' => NULL,
          'sid' => NULL,
          'related' => NULL,
          'statusid' => NULL,
          'statusdate' => NULL,
          'status' => NULL,
          'reviewer' => NULL,
        ),
      ),
      'template' => 'reviewer-status-page',
      'path' => drupal_get_path('module', 'modelreview') .'/tpl',
    ),
    'request_review_page' => array(
      'arguments' => array(
        'review' => array(
          'model_nid' => NULL,
        ),
      ),
      'template' => 'request-review-page',
      'path' => drupal_get_path('module', 'modelreview') .'/tpl',
    ),
    'review_queues_page' => array(
      'arguments' => array(
        'review' => array(
          'model_nid' => NULL,
          'modelversion_nid' => NULL,
          'rid' => NULL,
          'sid' => NULL,
          'related' => NULL,
          'statusid' => NULL,
          'statusdate' => NULL,
          'status' => NULL,
          'reviewer' => NULL,
        ),
      ),
      'template' => 'review-queues-page',
      'path' => drupal_get_path('module', 'modelreview') .'/tpl',
    ),
  );
}

/**
 * Implementation of hook_menu()
 */
function modelreview_menu() {
  // Review Status page
  $items['model/%/review/status'] = array(
    'title' => 'Review',
    'description' => "",
    'page callback' => '_modelreview_goto_status',
    'page arguments' => array(array(1)),
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('edit review', 'review model', 'edit any model', 'edit own model')),
    'type' => MENU_CALLBACK,
  );

  $items['model/%/review/status/author'] = array(
    'title' => 'Author',
    'description' => "",
    'page callback' => '_modelreview_status_page',
    'page arguments' => array(array(1, 4)),
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('edit any model', 'edit own model')),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  $items['model/%/review/status/editor'] = array(
    'title' => 'Editor',
    'description' => "",
    'page callback' => '_modelreview_status_page',
    'page arguments' => array(array(1, 4)),
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('edit review')),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );

  $items['model/%/review/status/reviewer'] = array(
    'title' => 'Reviewer',
    'description' => "",
    'page callback' => '_modelreview_status_page',
    'page arguments' => array(array(1, 4)),
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('review model')),
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  ); 

  // Info on model reviews and request page
  $items['model/%/review/info'] = array(
    'title' => 'Request A Model Review',
    'description' => "",
    'page callback' => '_modelreview_request_page',
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('edit any model', 'edit own model')),
    'type' => MENU_CALLBACK,
  );
  
  $items['models/reviews'] = array(
    'title' => 'Reviews',
    'description' => "",
    'page callback' => '_modelreview_queues_page',
    //'page arguments' => array(array(1, 4)),
    'access callback' => '_modelreview_access_content',
    'access arguments' => array(array('edit review', 'review model')),
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
  );

  $items['admin/settings/modelreview'] = array(
    'title' => 'Model Reviews Settings',
    'description' => "Configuration settings for Model Reviews",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_modelreview_admin_settings'),
    'access arguments' => array('administer model reviews'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function modelreview_perm() {
  return array(
    'review model',
    'edit review',
    'manage review',
    'administer model reviews',
  );
}

/**
 * Implementation of custom access callback function
 */
function _modelreview_access_content($perms) {

  // if author access requested
  if (in_array('edit own model', $perms)) {
    global $user;
    $modelnid = arg(1);

    $sql = "SELECT nid, uid FROM {node} WHERE type = 'model' AND node.nid = %d";
    $result = db_query($sql, $modelnid);
    $row = db_fetch_object($result);

    $author = $row->uid;
    $author_access = (($user->uid == 1) || (user_access('edit own model') && $user->uid == $author));
  }

  // if editor access requested
  if (in_array('edit review', $perms)) {
    $editor_access = (($user->uid == 1) || user_access('edit review'));
  }

  // if reviewer access requested
  // if reviewer hasn't been assigned yet, deny access
  if (in_array('review model', $perms)) {
    $modelnid = arg(1);
    $sql = "SELECT COUNT(*) FROM {modelreview} mr INNER JOIN {modelreview_action} mra ON mr.rid = mra.rid AND mr.sid = mra.sid WHERE mr.model_nid = %d AND mra.statusid > 10;";
    $result = db_query($sql, $modelnid);
    $review_count = db_result($result);

    $reviewer_access = ($review_count > 0) && (($user->uid == 1) || user_access('review model'));
  }

  return ($author_access || $editor_access || $reviewer_access);
}

function _modelreview_debug_request() {
  $modelnid = arg(1);

  drupal_goto('model/'. $modelnid .'/review/status/author');
}

function _modelreview_request_page() {
  return theme('request_review_page', array( 
        'model_nid' => $modelnid, 
      ));
}

/**
 * Implementation of page callback
 *
 * This redirects the user to the default Status tab.
 * 
 */
function _modelreview_goto_status() {
  global $user;
  $modelnid = arg(1);

  // Determine who is viewing the Status page and the current Review Status Code
  // Lookup the Model author
  $sql = "SELECT nid, uid FROM {node} WHERE type = 'model' AND node.nid = %d";
  $result = db_query($sql, $modelnid);
  $row = db_fetch_object($result);
  $author = $row->uid;

  // Lookup Review for Assigned Reviewer
  $sql = "SELECT mr.model_nid, mra.rid, mra.sid, mra.statusid, mrad.status, statusdate, reviewer, field_fullname_value as reviewer_name "
        ."FROM {modelreview} mr INNER JOIN {modelreview_action} mra ON mr.rid = mra.rid AND mra.statusid = 20 "
        ."INNER JOIN {modelreview_actiondesc} mrad ON mra.statusid = mrad.statusid "
        ."LEFT JOIN {node} ON reviewer = node.uid AND node.type = 'profile' LEFT JOIN {content_type_profile} ctp ON node.vid = ctp.vid "
        ."WHERE mr.model_nid = %d";
  $result = db_query($sql, arg(1));
  $row = db_fetch_object($result);
  $reviewer = $row->reviewer_name;

  // set mode according to rules:
  // 1. If user owns model being viewed, use Author mode.
  // 2. If user is assigned as model Reviewer, then use Reviewer mode.
  // 3. If user is an Editor, then use Editor mode.
  if ($user->uid == $author) {
    drupal_goto('model/'. $modelnid .'/review/status/author');
  } elseif (user_access('edit review') && $user->uid == $reviewer) {
    drupal_goto('model/'. $modelnid .'/review/status/reviewer');
  } elseif (($user->uid == 1) || user_access('edit review')) {
    drupal_goto('model/'. $modelnid .'/review/status/editor');
  } else {
    drupal_set_message('You are not authorized to view this model information.');
    drupal_goto('page/invalid-request');
  }
}

/**
 * Implementation of page callback
 *
 * This is the Review Request Page, which a model author views prior to requesting
 * a review of their model.
 */
function _modelreview_request_review() {
  $modelnid = arg(1);

  // check if modelversion has been reviewed yet.
  // if not, then provide info on the process.
  // if so, then redirect to the review status page

  $sql = "SELECT COUNT(*) FROM {modelreview} mr INNER JOIN {modelreview_action} mra ON mr.rid = mra.rid AND mr.sid = mra.sid WHERE mr.model_nid = %d AND mra.statusid < 60;";
  $result = db_query($sql, $modelnid);
  $review_count = db_result($result);

  if ($review_count == 0) {
    $content = theme('request_review_page', array( 
        'model_nid' => $modelnid, 
      ));
    return $content; 
  } else {
    drupal_goto('model/'. $modelnid .'/review/status');
  } 
}


/**
 * Implementation of page callback
 *
 * This is the Review Status Page, which displays various summary info about an ongoing model review.
 * The specific information displayed and available actions that can be taken from here depends on
 * who is viewing the page.
 */
function _modelreview_status_page() {
  global $user;
  $modelnid = arg(1);

  // Lookup Review for Assigned Reviewer
  $sql = "SELECT mr.model_nid, mra.rid, mra.sid, mra.statusid, mrad.status, mra.statusdate, mra.reviewer, "
        ."field_fullname_value as reviewer_name FROM {modelreview} mr "
        ."INNER JOIN {modelreview_action} mra ON mr.rid = mra.rid AND mra.statusid = 20 "
        ."INNER JOIN {modelreview_actiondesc} mrad ON mra.statusid = mrad.statusid "
        ."LEFT JOIN {node} ON mra.reviewer = node.uid AND node.type = 'profile' "
        ."LEFT JOIN {content_type_profile} ctp ON node.vid = ctp.vid "
        ."WHERE mr.model_nid = %d";
  $result = db_query($sql, $modelnid);
  $row = db_fetch_object($result);
  $reviewer = $row->reviewer_name;

  $usermode = arg(4); // view status page in this mode (Author, Editor, or Reviewer)

  // lookup the current status of the open 'modelreview' record
  $sql = "SELECT mr.rid, mr.sid, mr.model_nid, modelversion_nid, related, mra.statusid, mrad.status, statusdate, reviewer FROM {modelreview} mr INNER JOIN {modelreview_action} mra ON mr.rid = mra.rid AND mr.sid = mra.sid INNER JOIN {modelreview_actiondesc} mrad ON mra.statusid = mrad.statusid WHERE mr.model_nid = %d";
  $result = db_query($sql, $modelnid);
  $row = db_fetch_object($result);

  switch ($usermode) {
    case 'author':
      $content = theme('author_status_page', array( 
        'model_nid' => $modelnid, 
        'modelversion_nid' => $row->modelversion_nid, 
        'rid' => $row->rid, 
        'sid' => $row->sid, 
        'related' => $row->related, 
        'statusid' => $row->statusid, 
        'statusdate' => $row->statusdate, 
        'status' => $row->status, 
        'reviewer' => $reviewer,
      ));
      break;

    case 'editor':
      $content = theme('editor_status_page', array(
        'model_nid' => $modelnid, 
        'modelversion_nid' => $row->modelversion_nid, 
        'rid' => $row->rid, 
        'sid' => $row->sid, 
        'related' => $row->related, 
        'statusid' => $row->statusid, 
        'statusdate' => $row->statusdate, 
        'status' => $row->status, 
        'reviewer' => $reviewer,
      ));
      break;

    case 'reviewer':
      $content = theme('reviewer_status_page', array(
        'model_nid' => $modelnid, 
        'modelversion_nid' => $row->modelversion_nid, 
        'rid' => $row->rid, 
        'sid' => $row->sid, 
        'related' => $row->related, 
        'statusid' => $row->statusid, 
        'statusdate' => $row->statusdate, 
        'status' => $row->status, 
        'reviewer' => $reviewer,
      ));
      break;
  }

  return $content;
}

/**
 * Implementation of page callback
 *
 * This is the Review Status Page, which displays various summary info about an ongoing model review.
 * The specific information displayed and available actions that can be taken from here depends on
 * who is viewing the page.
 */
function _modelreview_queues_page() {
  global $user;

  $content = theme('review_queues_page', array(
  ));

  return $content;
}

/**
 * Admin settings page
 */
function _modelreview_admin_settings() {
  $form = array();

  $form['notifications'] = array(
    '#type' => 'fieldset',
    '#title' => t('Email Notifications'),
    '#collapsible' => FALSE, 
    '#collapsed' => FALSE,
  );

  $form['notifications']['modelreview_emails_enabled'] = array(
    '#type' => 'radios', 
    '#title' => t('Enable/Disable Notifications'), 
    '#default_value' => variable_get('modelreview_emails_enabled', 0), 
    '#options' => array(t('Disabled'), t('Enabled')),
  );

  return system_settings_form($form);
}

